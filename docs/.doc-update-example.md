# 文档同步更新示例

## 当前状态检测

```bash
# 运行检测工具
python3 tools/sync-docs.py

# 输出显示：
# 需要更新的模块文档
### ts/CLAUDE.md
# - 变更文件数: 1
# - 主要变更: ts/lib/tslib/wrap.ts
```

## 自动更新流程

```bash
# 运行自动更新脚本
./tools/update-docs.sh
```

预期输出：
```
🚀 开始更新 Anki 上下文文档...

🔍 检查依赖...
✅ 依赖检查通过

📋 检查工作目录状态...
✅ 工作目录干净

🔍 检测需要更新的文档...
✅ 检测完成

💾 备份当前文档...
✅ 文档已备份到 .doc-backup-20251206-122045

🔄 生成模块文档更新...
⚠️  模块文档生成脚本不存在，跳过

📊 更新根文档统计信息...
✅ 根文档更新完成

✅ 验证文档质量...
⚠️  文档检查脚本不存在，跳过质量验证

📝 记录更新时间...
✅ 更新时间已记录

✨ 文档更新完成！

💡 建议的后续操作：
1. 查看更新计划: cat .doc-update-plan.md
2. 检查变更: git diff --name-only | grep CLAUDE.md
3. 提交变更:
   git add .
   git commit -m "docs: 更新上下文文档 (2025-12-06)"
   git push origin main
```

## 查看更新内容

```bash
# 查看哪些文档被修改
git diff --name-only | grep CLAUDE.md

# 查看具体变更
git diff CLAUDE.md
```

## 验证更新质量

```bash
# 运行文档质量检查
./tools/check-docs.sh
```

## 提交更新

```bash
# 添加所有变更
git add .

# 提交（使用描述性的信息）
git commit -m "docs: 同步更新 ts 模块文档，反映 wrap.ts 变更"

# 推送到远程
git push origin main
```

## 批量更新多个文档

如果同时有多个模块的文档需要更新：

```bash
# 生成详细的更新计划
python3 tools/sync-docs.py --output detailed-update-plan.md

# 查看计划
cat detailed-update-plan.md

# 批量更新
./tools/update-docs.sh
```

## CI 集成

在 CI/CD 流程中自动检查文档：

```yaml
# .github/workflows/doc-check.yml
name: Documentation Check

on:
  pull_request:
    paths:
      - '**/CLAUDE.md'

jobs:
  check-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Check if docs need update
        run: |
          python3 tools/sync-docs.py --ci-mode > doc-status.json

          # 解析 JSON 并设置退出码
          if python3 -c "import json; data=json.load(open('doc-status.json')); exit(1 if data['needs_update'] else 0)"; then
            echo "✅ 文档是最新的"
          else
            echo "⚠️ 文档需要更新"
            cat doc-status.json
            exit 1
          fi
```

## 故障处理

### 情况1：检测到误报

如果工具检测到需要更新，但实际上文档已经是最新的：

```bash
# 更新同步时间戳
echo "$(date -u +%Y-%m-%dT%H:%M:%S)" > .last-doc-sync

# 或者指定一个较早的时间
python3 tools/sync-docs.py --since 2025-12-05
```

### 情况2：更新后检查失败

如果更新后文档质量检查失败：

```bash
# 查看具体错误
./tools/check-docs.sh

# 根据错误信息修复
# 例如：修复 Mermaid 语法
python3 tools/check-mermaid-syntax.py
```

### 情况3：需要回滚更新

如果更新后需要回滚：

```bash
# 查看备份
ls -la .doc-backup-*

# 恢复备份
cp -r .doc-backup-20251206-122045/anki/CLAUDE.md ./CLAUDE.md

# 提交回滚
git add CLAUDE.md
git commit -m "docs: 回滚文档更新"
```

## 最佳实践总结

1. **定期检查**：每周运行一次完整的文档同步检查
2. **及时更新**：代码变更后尽快更新文档
3. **质量验证**：每次更新后运行质量检查
4. **备份习惯**：重要更新前手动备份
5. **清晰提交**：使用描述性的提交信息

通过遵循这些步骤和最佳实践，可以确保文档始终保持最新和准确。