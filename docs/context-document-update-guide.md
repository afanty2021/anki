# Anki 上下文文档更新指南

## 快速开始

### 自动更新（推荐）

```bash
# 1. 检查是否需要更新
./tools/sync-docs.py --check-only

# 2. 如果需要更新，运行自动更新脚本
./tools/update-docs.sh

# 3. 查看更新内容
git diff --name-only | grep CLAUDE.md

# 4. 提交更新
git add .
git commit -m "docs: 更新上下文文档 ($(date +%Y-%m-%d))"
git push origin main
```

### 手动更新

如果自动更新无法满足需求，可以按照以下步骤手动更新：

1. **分析变更影响**
   ```bash
   # 查看最近的代码变更
   git log --oneline --since="1 week ago" --name-only

   # 运行文档检测工具
   python3 tools/sync-docs.py
   ```

2. **更新相关文档**
   - 根据变更类型更新对应的 CLAUDE.md 文件
   - 更新模块结构图（Mermaid）
   - 更新索引和统计信息

3. **验证更新质量**
   ```bash
   ./tools/check-docs.sh
   ```

## 文档更新场景

### 1. 新增模块/目录

**触发条件**：
- 创建新的源代码目录
- 新增独立的功能模块

**更新步骤**：

1. **创建模块文档**
   ```bash
   # 在新模块目录下创建 CLAUDE.md
   echo "# 新模块名称" > new-module/CLAUDE.md
   ```

2. **更新根文档** (CLAUDE.md)
   - 在 Mermaid 图表中添加新模块节点
   - 在模块索引表中添加新模块行
   - 更新模块统计数据

3. **内容模板**：
   ```markdown
   # [模块名称] 项目 AI 上下文文档

   ## 更新日志
   - YYYY-MM-DD: 初始化模块文档

   ## 模块概述
   [简要描述模块的职责和功能]

   ## 核心功能
   - 功能1：[描述]
   - 功能2：[描述]

   ## 文件结构
   ```
   [列出主要文件和目录]
   ```

   ## 技术栈
   - [语言1]
   - [框架/库]

   ## 依赖关系
   - 依赖：[列出依赖的模块]
   - 被依赖：[列出依赖此模块的模块]

   ## 开发指南
   [开发此模块的注意事项]
   ```

### 2. 删除/废弃模块

**触发条件**：
- 模块被完全删除
- 模块功能被合并到其他模块

**更新步骤**：

1. **处理模块文档**
   - 如果模块完全删除：删除对应的 CLAUDE.md
   - 如果模块废弃：在文档中标记为废弃

2. **更新根文档**
   - 从 Mermaid 图表中移除节点
   - 从模块索引表中移除或标记
   - 更新统计数据

### 3. 重构/重组

**触发条件**：
- 文件结构重组
- 模块间依赖关系变化
- 架构调整

**更新步骤**：

1. **更新模块结构图**
   - 修改 Mermaid 图表反映新的结构
   - 更新节点间的连接关系

2. **更新模块文档**
   - 修改文件结构描述
   - 更新依赖关系说明
   - 调整导航链接

3. **验证一致性**
   ```bash
   # 检查所有链接是否有效
   ./tools/check-docs.sh
   ```

### 4. API 变更

**触发条件**：
- 函数签名变化
- 新增/删除接口
- 接口行为改变

**更新步骤**：

1. **识别受影响的模块**
   ```bash
   # 查找 API 相关的变更
   git log --grep="API\|interface\|method" --since="1 week ago"
   ```

2. **更新接口文档**
   - 更新函数签名
   - 添加使用示例
   - 说明变更原因

3. **更新示例代码**
   - 确保所有代码示例是最新的
   - 添加迁移指南（如果需要）

### 5. 依赖变更

**触发条件**：
- 添加新的依赖包
- 升级/降级依赖版本
- 移除不再使用的依赖

**更新步骤**：

1. **更新技术栈描述**
   - 在模块文档中更新依赖列表
   - 添加版本信息

2. **更新安装/运行说明**
   - 如果影响构建流程，更新构建文档
   - 更新环境要求

## 文档质量标准

### 内容要求

1. **准确性**
   - 所有信息必须与实际代码一致
   - 示例代码必须可运行

2. **完整性**
   - 包含必要的使用说明
   - 提供完整的上下文信息

3. **清晰性**
   - 使用简洁明了的语言
   - 避免歧义表达

### 格式要求

1. **Markdown 规范**
   - 使用标准 Markdown 语法
   - 标题层级清晰（# → ## → ###）

2. **Mermaid 图表**
   - 语法正确
   - 节点命名一致
   - 布局合理

3. **代码块**
   - 指定语言类型
   - 保持缩进一致

### 一致性要求

1. **术语统一**
   - 模块名称统一
   - 技术术语一致

2. **结构统一**
   - 所有模块文档遵循相同的章节结构
   - 导航格式一致

## 工具使用

### 1. 文档同步检测 (sync-docs.py)

```bash
# 基本使用
python3 tools/sync-docs.py

# 仅检查是否需要更新
python3 tools/sync-docs.py --check-only

# 指定起始日期
python3 tools/sync-docs.py --since 2025-01-01

# 输出到文件
python3 tools/sync-docs.py --output update-plan.md

# CI 模式（JSON 输出）
python3 tools/sync-docs.py --ci-mode
```

### 2. 文档更新 (update-docs.sh)

```bash
# 完整更新流程
./tools/update-docs.sh

# 仅检查
./tools/update-docs.sh --check-only

# 跳过备份
./tools/update-docs.sh --no-backup
```

### 3. 文档质量检查 (check-docs.sh)

```bash
# 完整检查
./tools/check-docs.sh

# 仅检查语法
./tools/check-docs.sh --syntax-only

# 仅检查链接
./tools/check-docs.sh --links-only
```

### 4. 结构检查 (check-doc-structure.py)

```bash
# 检查所有文档结构
python3 tools/check-doc-structure.py
```

### 5. Mermaid 语法检查 (check-mermaid-syntax.py)

```bash
# 检查 Mermaid 图表语法
python3 tools/check-mermaid-syntax.py
```

## 最佳实践

### 1. 更新时机

- **代码提交前**：检查是否需要更新文档
- **功能完成时**：立即更新相关文档
- **重构完成后**：批量更新受影响的文档
- **定期维护**：每周运行一次完整检查

### 2. 提交规范

```bash
# 好的提交信息
git commit -m "docs: 更新调度器模块文档，添加新的 FSRS 算法说明"

# 包含变更范围
git commit -m "docs(ts): 更新前端模块，新增 React 组件说明"
```

### 3. 审查流程

1. **自我审查**
   - 运行 `./tools/check-docs.sh`
   - 检查语法和链接

2. **同行审查**
   - 请相关模块的专家审查
   - 关注技术准确性

3. **自动化验证**
   - CI 自动运行检查
   - 确保质量标准

### 4. 维护建议

1. **版本控制**
   - 保留文档变更历史
   - 使用有意义的提交信息

2. **备份策略**
   - 更新前自动备份
   - 保留最近几个版本的备份

3. **反馈收集**
   - 定期收集团队反馈
   - 持续改进文档质量

## 常见问题

### Q1: 如何处理大型重构？

A: 对于影响多个模块的大型重构：
1. 创建特性分支
2. 分阶段更新文档
3. 每个阶段都运行质量检查
4. 最后统一提交

### Q2: 文档更新后构建失败怎么办？

A: 可能的原因和解决方法：
1. **Mermaid 语法错误**：运行 `check-mermaid-syntax.py` 定位问题
2. **链接失效**：运行 `check-docs.sh --links-only` 检查链接
3. **编码问题**：确保文件使用 UTF-8 编码

### Q3: 如何批量更新多个相似模块？

A: 创建批量更新脚本：
```python
# 示例：批量更新模块版本信息
modules = ['ts', 'qt', 'rslib']
for module in modules:
    doc_path = f"{module}/CLAUDE.md"
    # 执行更新操作
```

### Q4: 如何处理过时的文档？

A: 标记过时内容而不是删除：
```markdown
> ⚠️ **注意**：此部分内容已过时，新版本请参考 [新文档链接]
```

## 总结

保持文档与代码同步是项目成功的关键因素之一。通过使用这套完整的工具和流程，可以：

1. **及时发现问题**：自动化检测减少遗漏
2. **保证文档质量**：多重检查确保准确性
3. **提高更新效率**：自动化工具减轻工作量
4. **降低维护成本**：标准化的流程减少错误

记住：好的文档是项目的一部分，而不是额外负担。投资文档质量就是投资项目的长期成功。