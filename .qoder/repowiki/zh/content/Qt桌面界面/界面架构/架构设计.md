# 架构设计

<cite>
**本文档中引用的文件**  
- [__init__.py](file://qt/aqt/__init__.py)
- [main.py](file://qt/aqt/main.py)
</cite>

## 目录
1. [界面分层架构](#界面分层架构)
2. [模块初始化与依赖注入](#模块初始化与依赖注入)
3. [主应用程序窗口构建](#主应用程序窗口构建)
4. [组件加载顺序与依赖关系](#组件加载顺序与依赖关系)

## 界面分层架构

Anki Qt界面采用分层架构模式，将界面层划分为视图层、控制器层和业务逻辑层。视图层负责用户界面的展示和用户交互，控制器层处理用户输入并协调视图与业务逻辑之间的交互，业务逻辑层则封装核心功能和数据处理。

在Anki的实现中，`AnkiQt`类作为主控制器，继承自`QMainWindow`，管理整个应用程序的生命周期和状态转换。视图层由多个`QWidget`组件构成，包括主窗口、工具栏、底部状态栏等。业务逻辑层通过`Collection`类与后端Rust引擎交互，执行卡片管理、学习调度等核心功能。

这种分层设计实现了关注点分离，使得界面组件可以独立开发和测试，同时通过清晰的接口定义保证了各层之间的松耦合。例如，当用户在界面执行操作时，控制器层会调用相应的业务逻辑方法，而无需关心具体的实现细节。

**Section sources**
- [main.py](file://qt/aqt/main.py#L185-L233)
- [main.py](file://qt/aqt/main.py#L235-L257)

## 模块初始化与依赖注入

Anki的模块初始化流程在`__init__.py`文件中定义，通过全局变量和函数实现依赖注入机制。启动时，系统首先创建`AnkiApp`实例，该实例继承自`QApplication`并添加了单实例支持和消息处理功能。

依赖注入主要通过以下方式实现：`setupLangAndBackend`函数负责初始化语言环境和后端引擎，将`ProfileManager`和`QApplication`实例作为参数传入，并返回配置好的`RustBackend`实例。这种显式的依赖传递确保了组件之间的依赖关系清晰可见，便于测试和维护。

`DialogManager`类实现了对话框的依赖管理，通过注册机制管理所有窗口实例的生命周期。当需要打开特定对话框时，系统会检查是否已存在实例，若存在则激活该实例，否则创建新实例并注册到管理器中。这种方式避免了重复创建窗口，同时确保了资源的正确释放。

**Section sources**
- [__init__.py](file://qt/aqt/__init__.py#L229-L282)
- [__init__.py](file://qt/aqt/__init__.py#L124-L213)

## 主应用程序窗口构建

主应用程序窗口的构建过程在`AnkiQt`类的初始化方法中完成。构造函数接收`AnkiApp`、`ProfileManager`、`RustBackend`等核心组件作为参数，建立应用程序的上下文环境。

窗口构建流程始于`setupUI`方法，该方法按特定顺序初始化各个子系统：首先设置消息处理、快捷键、线程管理等基础功能，然后初始化媒体服务器、进度管理器和错误处理器。接着创建主窗口界面，包括顶部工具栏、主内容区域和底部状态栏，并通过垂直布局管理器将它们组织在一起。

生命周期管理通过状态机模式实现，`state`属性记录当前应用状态（如"deckBrowser"、"overview"、"review"等）。`moveToState`方法负责状态转换，调用相应的清理和初始化方法，确保界面在不同状态间平滑过渡。例如，从牌组浏览器切换到复习模式时，系统会先执行清理操作，然后显示复习界面。

**Section sources**
- [main.py](file://qt/aqt/main.py#L185-L233)
- [main.py](file://qt/aqt/main.py#L957-L984)

## 组件加载顺序与依赖关系

界面组件的加载遵循严格的依赖顺序，确保所有前置条件都已满足。启动流程从`run`函数开始，首先解析命令行参数，然后创建`ProfileManager`实例管理用户配置。接着调用`setupGL`配置图形渲染环境，处理可能的OpenGL错误。

在`AnkiQt`初始化过程中，组件按以下顺序加载：应用消息处理器 → 快捷键系统 → 线程管理器 → 媒体服务器 → 进度管理器 → 主窗口界面 → 系统特定功能 → 菜单系统 → 错误处理器 → 信号处理器 → 钩子系统 → 定时器 → 标题栏。这种顺序确保了基础服务在使用前已准备就绪。

关键依赖关系包括：`MainWebView`依赖`AnkiWebView`基类和`AnkiWebViewKind`枚举；`Toolbar`依赖`TopWebView`；`Reviewer`、`DeckBrowser`和`Overview`等核心界面组件都依赖`AnkiQt`主控制器。这些依赖关系通过构造函数参数显式声明，保证了组件间的松耦合和可测试性。

**Section sources**
- [main.py](file://qt/aqt/main.py#L306-L329)
- [main.py](file://qt/aqt/main.py#L510-L568)
- [main.py](file://qt/aqt/main.py#L683-L686)