# 表格视图实现

<cite>
**本文档中引用的文件**  
- [table.py](file://qt/aqt/browser/table/table.py)
- [model.py](file://qt/aqt/browser/table/model.py)
- [state.py](file://qt/aqt/browser/table/state.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档深入解析Anki浏览器表格视图的实现机制，重点分析`table.py`中的`AnkiTableView`类、`model.py`中的`BrowserModel`Qt抽象模型实现，以及`state.py`中的表格状态持久化机制。文档涵盖自定义排序、列宽管理、行高计算、选择模式等核心功能，并提供大规模数据渲染的性能优化策略。

## 项目结构
Anki浏览器表格视图的实现主要位于`qt/aqt/browser/table`目录下，包含三个核心文件：`table.py`、`model.py`和`state.py`，分别负责视图控制、数据模型和状态管理。

```mermaid
graph TD
subgraph "表格视图组件"
table[Table]
model[DataModel]
state[ItemState]
end
table --> model
model --> state
table --> state
```

**图表来源**  
- [table.py](file://qt/aqt/browser/table/table.py)
- [model.py](file://qt/aqt/browser/table/model.py)
- [state.py](file://qt/aqt/browser/table/state.py)

## 核心组件
表格视图的核心组件包括`Table`类（视图控制器）、`DataModel`类（数据模型）和`ItemState`类（状态管理器），它们共同实现了浏览器表格的完整功能。

**章节来源**  
- [table.py](file://qt/aqt/browser/table/table.py#L1-L50)
- [model.py](file://qt/aqt/browser/table/model.py#L1-L50)
- [state.py](file://qt/aqt/browser/table/state.py#L1-L50)

## 架构概述
Anki浏览器表格视图采用经典的MVC（Model-View-Controller）架构模式，其中`DataModel`作为模型层，`Table`作为控制器，而Qt的`QTableView`作为视图层。

```mermaid
graph TD
subgraph "MVC架构"
View[QTableView]
Controller[Table]
Model[DataModel]
end
View --> Controller
Controller --> Model
Model --> View
```

**图表来源**  
- [table.py](file://qt/aqt/browser/table/table.py#L1-L20)
- [model.py](file://qt/aqt/browser/table/model.py#L1-L20)

## 详细组件分析

### Table类分析
`Table`类是浏览器表格的主控制器，负责管理视图、处理用户交互和协调数据模型。

#### 类图
```mermaid
classDiagram
class Table {
+SELECTION_LIMIT : int
-browser : Browser
-col : Collection
-_state : ItemState
-_model : DataModel
-_view : QTableView
-_len_selection : int
+__init__(browser)
+set_view(view)
+cleanup()
+len()
+len_selection()
+has_current()
+has_previous()
+has_next()
+is_notes_mode()
+get_current_card()
+get_current_note()
+get_single_selected_card()
+get_selected_card_ids()
+get_selected_note_ids()
+get_card_ids_from_selected_note_ids()
+select_all()
+clear_selection()
+invert_selection()
+select_single_card(card_id)
+reset()
+begin_reset()
+end_reset()
+on_backend_will_block()
+on_backend_did_block()
+redraw_cells()
+op_executed(changes, handler, focused)
+search(txt)
+toggle_state(is_notes_mode, last_search)
+to_previous_row()
+to_next_row()
+to_first_row()
+to_last_row()
+to_row_of_unselected_note()
+clear_current()
+_current()
+_selected()
+_set_current(row, column)
+_reset_selection()
+_select_rows(rows)
+_set_sort_indicator()
+_set_column_sizes()
+_save_header()
+_restore_header()
+_setup_view()
+_update_font()
+_setup_headers()
+_on_current_changed(current, previous)
+_on_selection_changed(selected, deselected)
+_on_row_state_will_change(index, was_restored)
+_on_row_state_changed(index, was_restored)
+_on_context_menu(point)
+_on_header_context(pos)
+_on_column_moved(args)
+_on_column_toggled(checked, column)
+_on_sort_column_changed(section, order)
+_reverse()
+_save_selection()
+_restore_selection(new_selected_and_current)
+_qualify_selected_rows(rows, current)
+_intersected_selection()
+_toggled_selection()
+_scroll_to_row(row, scroll_even_if_visible)
+_scroll_to_column(column)
+_move_current_to_index(index)
+_move_current(direction)
+_move_current_to_row(row)
+_selection_model()
+_horizontal_header()
}
class StatusDelegate {
-browser : Browser
-model : DataModel
+__init__(browser, model)
+paint(painter, option, index)
}
Table --> StatusDelegate
Table --> DataModel
Table --> ItemState
```

**图表来源**  
- [table.py](file://qt/aqt/browser/table/table.py#L1-L688)

**章节来源**  
- [table.py](file://qt/aqt/browser/table/table.py#L1-L688)

### DataModel类分析
`DataModel`类是表格视图的数据模型，继承自`QAbstractTableModel`，负责管理表格数据的获取、缓存和更新。

#### 类图
```mermaid
classDiagram
class DataModel {
-col : Collection
-columns : dict[str, Column]
-_state : ItemState
-_items : Sequence[ItemId]
-_rows : dict[int, CellRow]
-_block_updates : bool
-_stale_cutoff : float
-_on_row_state_will_change : Callable
-_on_row_state_changed : Callable
-_want_tooltips : bool
+__init__(parent, col, state, row_state_will_change_callback, row_state_changed_callback)
+get_cell(index)
+get_row(index)
+_fetch_row_and_update_cache(index, item, old_row)
+_fetch_row_from_backend(item)
+get_cached_row(index)
+mark_cache_stale()
+reset()
+begin_reset()
+end_reset()
+begin_blocking()
+end_blocking()
+redraw_cells()
+is_empty()
+len_rows()
+len_columns()
+get_item(index)
+get_items(indices)
+get_card_ids(indices)
+get_note_ids(indices)
+get_note_id(index)
+get_item_row(item)
+get_item_rows(items)
+get_card_row(card_id)
+get_card(index)
+get_note(index)
+toggle_state(context)
+search(context)
+_search_inner(context)
+reverse()
+column_at(index)
+column_at_section(section)
+active_column_index(column)
+toggle_column(column)
+rowCount(parent)
+columnCount(parent)
+data(index, role)
+headerData(section, orientation, role)
+flags(index)
}
class addon_column_fillin {
+key : str
+cards_mode_label : str
+notes_mode_label : str
+sorting_cards : int
+sorting_notes : int
+uses_cell_font : bool
+alignment : int
}
DataModel --> addon_column_fillin
DataModel --> ItemState
```

**图表来源**  
- [model.py](file://qt/aqt/browser/table/model.py#L1-L381)

**章节来源**  
- [model.py](file://qt/aqt/browser/table/model.py#L1-L381)

### ItemState类分析
`ItemState`类是表格状态的抽象基类，定义了卡片模式和笔记模式之间的状态切换和数据映射。

#### 类图
```mermaid
classDiagram
class ItemState {
<<abstract>>
+GEOMETRY_KEY_PREFIX : str
+SORT_COLUMN_KEY : str
+SORT_BACKWARDS_KEY : str
-_active_columns : list[str]
-col : Collection
-_sort_column : str
-_sort_backwards : bool
+__init__(col)
+is_notes_mode()
+note_ids_from_card_ids(items)
+card_ids_from_note_ids(items)
+column_key_at(index)
+column_label(column)
+column_tooltip(column)
+active_columns : list[str]
+toggle_active_column(column)
+sort_column : str
+sort_backwards : bool
+get_card(item)
+get_note(item)
+find_items(search, order, reverse)
+get_item_from_card_id(card)
+get_card_ids(items)
+get_note_ids(items)
+toggle_state()
+get_new_items(old_items)
}
class CardState {
+GEOMETRY_KEY_PREFIX : str
+SORT_COLUMN_KEY : str
+SORT_BACKWARDS_KEY : str
+__init__(col)
+active_columns : list[str]
+toggle_active_column(column)
+get_card(item)
+get_note(item)
+find_items(search, order, reverse)
+get_item_from_card_id(card)
+get_card_ids(items)
+get_note_ids(items)
+toggle_state()
+get_new_items(old_items)
}
class NoteState {
+GEOMETRY_KEY_PREFIX : str
+SORT_COLUMN_KEY : str
+SORT_BACKWARDS_KEY : str
+__init__(col)
+active_columns : list[str]
+toggle_active_column(column)
+get_card(item)
+get_note(item)
+find_items(search, order, reverse)
+get_item_from_card_id(card)
+get_card_ids(items)
+get_note_ids(items)
+toggle_state()
+get_new_items(old_items)
}
ItemState <|-- CardState
ItemState <|-- NoteState
```

**图表来源**  
- [state.py](file://qt/aqt/browser/table/state.py#L1-L224)

**章节来源**  
- [state.py](file://qt/aqt/browser/table/state.py#L1-L224)

## 依赖分析
表格视图组件之间存在紧密的依赖关系，`Table`类依赖`DataModel`和`ItemState`，而`DataModel`又依赖`ItemState`。

```mermaid
graph TD
Table --> DataModel
Table --> ItemState
DataModel --> ItemState
DataModel --> Column
DataModel --> Cell
DataModel --> CellRow
DataModel --> SearchContext
Table --> StatusDelegate
```

**图表来源**  
- [table.py](file://qt/aqt/browser/table/table.py)
- [model.py](file://qt/aqt/browser/table/model.py)
- [state.py](file://qt/aqt/browser/table/state.py)

**章节来源**  
- [table.py](file://qt/aqt/browser/table/table.py#L1-L688)
- [model.py](file://qt/aqt/browser/table/model.py#L1-L381)
- [state.py](file://qt/aqt/browser/table/state.py#L1-L224)

## 性能考虑
表格视图在处理大规模数据时采用了多种性能优化策略，包括数据缓存、增量更新和选择计数优化。

### 数据缓存机制
`DataModel`类通过`_rows`字典缓存已获取的行数据，避免重复查询数据库。当后端数据可能发生变化时，通过`mark_cache_stale()`方法标记缓存过期。

### 选择计数优化
对于大规模选择，`len_selection()`方法通过维护`_len_selection`变量来避免调用`QItemSelectionModel.selectedRows()`，后者在大规模选择时性能较差。

### 增量更新
当后端操作可能影响表格数据时，`op_executed()`方法会调用`mark_cache_stale()`标记缓存过期，并在必要时触发`redraw_cells()`进行增量更新。

**章节来源**  
- [model.py](file://qt/aqt/browser/table/model.py#L1-L381)
- [table.py](file://qt/aqt/browser/table/table.py#L1-L688)

## 故障排除指南
### 常见问题
1. **表格数据未更新**：检查是否调用了`op_executed()`方法，确保`mark_cache_stale()`被正确调用。
2. **列宽设置不保存**：检查`_save_header()`和`_restore_header()`方法是否正常工作。
3. **排序指示器不显示**：检查`_set_sort_indicator()`方法中的逻辑是否正确。

### 调试技巧
1. 使用`gui_hooks`调试钩子监控数据获取过程。
2. 检查`_block_updates`标志的状态，确保在后端阻塞时正确处理。
3. 验证`_stale_cutoff`时间戳是否正确更新。

**章节来源**  
- [table.py](file://qt/aqt/browser/table/table.py#L1-L688)
- [model.py](file://qt/aqt/browser/table/model.py#L1-L381)

## 结论
Anki浏览器表格视图通过精心设计的MVC架构实现了高效的数据展示和交互功能。`Table`、`DataModel`和`ItemState`三个核心组件各司其职，通过清晰的接口和依赖关系协同工作。系统采用了多种性能优化策略，确保在处理大规模数据时仍能保持良好的响应速度。状态持久化机制使得用户自定义的列设置、排序方式等能够跨会话保存，提升了用户体验。