# 前端集成

<cite>
**本文档中引用的文件**  
- [ftl-helpers.ts](file://ts/lib/generated/ftl-helpers.ts)
- [index.ts](file://ts/lib/tslib/i18n/index.ts)
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts)
- [typescript.rs](file://rslib/i18n/typescript.rs)
- [webview.py](file://qt/aqt/webview.py)
- [lib.rs](file://rslib/i18n/src/lib.rs)
- [i18n.proto](file://proto/anki/i18n.proto)
</cite>

## 目录
1. [简介](#简介)
2. [类型安全的国际化函数生成](#类型安全的国际化函数生成)
3. 前端i18n服务实现
4. Svelte组件中的i18n使用模式
5. Python-JavaScript消息传递机制
6. 性能优化建议
7. 调试技巧

## 简介
Anki的前端国际化系统采用Fluent本地化框架，通过类型安全的代码生成和高效的运行时服务，为Svelte组件提供编译时检查和动态文本支持。该系统通过Python后端与前端JavaScript的协同工作，实现了多语言支持的无缝集成。

## 类型安全的国际化函数生成

Anki通过Rust工具在构建时从FTL（Fluent）文件生成类型安全的TypeScript函数。这些函数提供编译时检查，防止使用不存在的文本ID。

```mermaid
classDiagram
class FTL文件 {
+actions.ftl
+adding.ftl
+browsing.ftl
+card-stats.ftl
}
class TypeScript生成器 {
+render_methods()
+get_arg_types()
+get_args()
+typescript_arg_name()
}
class 生成的类型安全函数 {
+translateKey()
+formatNumber()
+getMessage()
}
FTL文件 --> TypeScript生成器 : 输入
TypeScript生成器 --> 生成的类型安全函数 : 输出
```

**图示来源**
- [typescript.rs](file://rslib/i18n/typescript.rs#L43-L89)

**章节来源**
- [typescript.rs](file://rslib/i18n/typescript.rs#L43-L89)
- [ftl-helpers.ts](file://ts/lib/generated/ftl-helpers.ts#L0-L56)

### 代码生成机制
Rust工具`rslib/i18n/typescript.rs`中的`render_methods`函数遍历所有翻译模块，为每个文本ID生成对应的TypeScript函数。函数名采用驼峰命名法，将连字符替换为下划线。

```mermaid
flowchart TD
Start([开始生成]) --> ReadFTL["读取FTL文件"]
ReadFTL --> ParseTranslation["解析翻译条目"]
ParseTranslation --> GenerateFunction["生成TypeScript函数"]
GenerateFunction --> FormatArgs["格式化参数"]
FormatArgs --> WriteFunction["写入ftl-helpers.ts"]
WriteFunction --> CheckNext["是否有下一个条目?"]
CheckNext --> |是| ParseTranslation
CheckNext --> |否| End([完成生成])
```

**图示来源**
- [typescript.rs](file://rslib/i18n/typescript.rs#L43-L89)

**章节来源**
- [typescript.rs](file://rslib/i18n/typescript.rs#L43-L89)

### 类型安全保证
生成的函数具有完整的TypeScript类型定义，确保在编译时就能捕获错误的文本ID引用或不正确的参数类型。

```mermaid
classDiagram
class FluentBundle {
+locales : string[]
+getMessage(key : string) : Message
+formatPattern(pattern : Pattern, args : Args) : string
}
class FluentResource {
+source : string
+parse() : Resource
}
class FluentNumber {
+value : number
+options : NumberOptions
}
class translate {
+key : string
+args : Record<string, FluentVariable>
+返回 : string
}
FluentBundle --> FluentResource : 使用
FluentBundle --> FluentNumber : 使用
translate --> FluentBundle : 调用
```

**图示来源**
- [ftl-helpers.ts](file://ts/lib/generated/ftl-helpers.ts#L0-L56)

**章节来源**
- [ftl-helpers.ts](file://ts/lib/generated/ftl-helpers.ts#L0-L56)

## 前端i18n服务实现

前端i18n服务在`ts/lib/tslib/i18n/utils.ts`中实现，提供文本格式化、缓存机制和异步加载策略。

### 服务架构
```mermaid
graph TD
A[setupI18n] --> B[i18nResources]
B --> C[获取翻译资源]
C --> D[解析JSON]
D --> E[创建FluentBundle]
E --> F[setBundles]
F --> G[设置文档方向]
G --> H[完成初始化]
```

**图示来源**
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L51-L109)

**章节来源**
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L51-L109)

### 文本格式化功能
i18n服务提供多种文本格式化功能，包括数字、日期和字符串比较。

```mermaid
classDiagram
class i18n服务 {
+localizedNumber(n : number, precision : number) : string
+createLocaleNumberFormat(options : NumberFormatOptions) : NumberFormat
+localeCompare(first : string, second : string, options : CollatorOptions) : number
+withCollapsedWhitespace(s : string) : string
+withoutUnicodeIsolation(s : string) : string
+setupI18n(args : {modules : ModuleName[]}) : Promise<void>
+setupGlobalI18n() : Promise<void>
}
i18n服务 --> FluentBundle : 依赖
i18n服务 --> Intl.NumberFormat : 依赖
i18n服务 --> Intl.Collator : 依赖
```

**图示来源**
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L51-L109)

**章节来源**
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L51-L109)

### 缓存与异步加载
服务采用异步加载策略，通过Promise缓存机制避免重复初始化。

```mermaid
flowchart TD
Start([setupGlobalI18n]) --> CheckCache["检查globalI18n缓存"]
CheckCache --> |未初始化| Initialize["调用setupI18n"]
Initialize --> StorePromise["存储Promise到globalI18n"]
StorePromise --> ReturnPromise["返回Promise"]
CheckCache --> |已初始化| ReturnExisting["返回现有Promise"]
ReturnExisting --> WaitPromise["等待Promise完成"]
ReturnPromise --> WaitPromise
WaitPromise --> End([完成])
```

**图示来源**
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L100-L109)

**章节来源**
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L100-L109)

## Svelte组件中的i18n使用模式

在Svelte组件中使用`$lib/tslib/i18n`的正确模式包括在模板中使用`t()`函数和在脚本中处理动态文本。

### 模板使用模式
```mermaid
sequenceDiagram
participant Template as Svelte模板
participant Script as 脚本部分
participant I18n as i18n服务
Template->>I18n : {{t.functionName()}}
I18n-->>Template : 返回翻译文本
Script->>I18n : await setupI18n()
I18n-->>Script : 完成初始化
Script->>Template : $ : console.log(t.firstLanguage())
```

**图示来源**
- [index.ts](file://ts/lib/tslib/i18n/index.ts#L0-L6)
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L51-L109)

**章节来源**
- [index.ts](file://ts/lib/tslib/i18n/index.ts#L0-L6)
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L51-L109)

### 动态文本处理
在脚本中处理动态文本时，需要确保i18n服务已正确初始化。

```mermaid
flowchart TD
A[组件初始化] --> B[调用setupI18n]
B --> C[等待Promise]
C --> D[使用翻译函数]
D --> E[处理动态参数]
E --> F[更新UI]
```

**图示来源**
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L51-L109)

**章节来源**
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L51-L109)

## Python-JavaScript消息传递机制

`webview.py`中实现的Python-JavaScript消息传递机制负责将当前语言环境同步到前端。

### 消息传递架构
```mermaid
graph LR
A[Python后端] --> B[AnkiWebPage]
B --> C[QWebChannel]
C --> D[JavaScript桥接]
D --> E[前端i18n服务]
E --> F[更新UI]
```

**图示来源**
- [webview.py](file://qt/aqt/webview.py#L0-L1014)

**章节来源**
- [webview.py](file://qt/aqt/webview.py#L0-L1014)

### 语言环境同步流程
```mermaid
sequenceDiagram
participant Python as Python后端
participant WebView as AnkiWebView
participant JS as JavaScript
Python->>WebView : 设置语言环境
WebView->>WebView : 更新lang变量
WebView->>JS : 通过桥接发送语言变更
JS->>JS : 调用setupI18n
JS->>Python : 请求翻译资源
Python-->>JS : 返回JSON资源
JS->>JS : 初始化FluentBundle
JS-->>WebView : 更新文档方向
```

**图示来源**
- [webview.py](file://qt/aqt/webview.py#L0-L1014)
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L51-L109)

**章节来源**
- [webview.py](file://qt/aqt/webview.py#L0-L1014)
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L51-L109)

## 性能优化建议

### 文本包的懒加载
```mermaid
flowchart TD
A[应用启动] --> B[加载核心翻译]
B --> C[按需加载模块]
C --> D[缓存已加载模块]
D --> E[避免重复加载]
```

**章节来源**
- [lib.rs](file://rslib/i18n/src/lib.rs#L299-L339)

### 按需加载策略
```mermaid
classDiagram
class I18n {
+resources_for_js(desired_modules : string[]) : ResourcesForJavascript
+get_modules(langs : LanguageIdentifier[], desired_modules : string[]) : string[]
}
class ResourcesForJavascript {
+langs : string[]
+resources : string[]
}
I18n --> ResourcesForJavascript : 返回
```

**图示来源**
- [lib.rs](file://rslib/i18n/src/lib.rs#L299-L339)

**章节来源**
- [lib.rs](file://rslib/i18n/src/lib.rs#L299-L339)

## 调试技巧

### 热重载翻译文件
```mermaid
flowchart TD
A[修改FTL文件] --> B[触发构建]
B --> C[重新生成ts文件]
C --> D[前端自动刷新]
D --> E[查看翻译效果]
```

**章节来源**
- [typescript.rs](file://rslib/i18n/typescript.rs#L43-L89)
- [utils.ts](file://ts/lib/tslib/i18n/utils.ts#L51-L109)

### 错误处理
```mermaid
flowchart TD
A[查找文本ID] --> B{ID存在?}
B --> |是| C[返回翻译文本]
B --> |否| D[返回'missing key: ${key}']
D --> E[控制台警告]
```

**图示来源**
- [ftl-helpers.ts](file://ts/lib/generated/ftl-helpers.ts#L0-L56)

**章节来源**
- [ftl-helpers.ts](file://ts/lib/generated/ftl-helpers.ts#L0-L56)