# 主题系统

<cite>
**本文档中引用的文件**  
- [_color-palette.scss](file://ts/lib/sass/_color-palette.scss)
- [night-mode.scss](file://ts/lib/sass/night-mode.scss)
- [bootstrap-dark.scss](file://ts/lib/sass/bootstrap-dark.scss)
- [theme.py](file://qt/aqt/theme.py)
- [_vars.scss](file://ts/lib/sass/_vars.scss)
</cite>

## 目录
1. [简介](#简介)
2. [调色板架构](#调色板架构)
3. [夜间模式实现机制](#夜间模式实现机制)
4. [深色主题与标准样式的覆盖关系](#深色主题与标准样式的覆盖关系)
5. [主题管理JavaScript逻辑](#主题管理javascript逻辑)
6. [自定义主题指南](#自定义主题指南)
7. [结论](#结论)

## 简介
Anki主题系统提供了一套完整的视觉样式管理方案，支持深色/浅色模式切换和可扩展的主题定制。该系统基于Sass预处理器构建，结合前端CSS变量与后端Python逻辑，实现了跨平台一致的用户体验。本文档深入分析其核心组件，包括调色板定义、夜间模式切换、样式覆盖机制以及动态主题管理。

## 调色板架构

Anki的调色板架构在`_color-palette.scss`文件中定义，采用结构化映射方式组织颜色变量。调色板包含主色系（如blue、green）、辅助色系（如amber、cyan）以及自定义灰阶（lightgray和darkgray），共16个颜色类别，每个类别提供从0到9的10个明暗层级。

主色系主要来源于Tailwind CSS v3调色板，确保色彩一致性与美观性。辅助色用于标记、状态指示等场景。灰阶部分为Anki自定义，lightgray用于浅色模式下的背景和边框，darkgray用于深色模式下的对应元素。

颜色通过Sass映射结构存储，支持通过`palette($key, $shade)`函数按名称和层级访问。例如`palette(blue, 5)`获取主蓝色。这种设计实现了颜色的集中管理和灵活调用。

**Section sources**
- [_color-palette.scss](file://ts/lib/sass/_color-palette.scss#L0-L213)

## 夜间模式实现机制

夜间模式的切换机制由CSS和JavaScript协同实现。核心逻辑位于`night-mode.scss`和`theme.py`中。系统通过在DOM根元素或body标签上添加`nightMode`类来触发样式切换。

在Sass层面，`night-mode.scss`定义了输入元素在夜间模式下的样式规则：背景色使用`--canvas-inset`变量，边框色使用`--border`变量，并确保焦点状态保持一致的背景色。这些CSS变量的实际值由主题管理系统动态注入。

在Python层面，`ThemeManager`类负责检测和应用夜间模式状态。它根据用户设置或系统偏好（通过`get_windows_dark_mode`、`get_macos_dark_mode`等函数）确定是否启用夜间模式，并相应地更新Qt应用的调色板和样式表。

**Section sources**
- [night-mode.scss](file://ts/lib/sass/night-mode.scss#L0-L11)
- [theme.py](file://qt/aqt/theme.py#L0-L433)

## 深色主题与标准样式的覆盖关系

`bootstrap-dark.scss`文件实现了深色主题对标准Bootstrap样式的覆盖。该文件通过`@use "vars"`导入变量系统，并定义`night-mode`混合宏，专门针对`input`和`select`元素设置深色背景和边框。

其覆盖机制基于CSS优先级和变量继承。当启用夜间模式时，这些深色样式规则会覆盖默认的浅色样式。关键设计是使用CSS自定义属性（如`var(--canvas-inset)`），使得样式值可以从外部动态注入，实现了主题的可配置性。

该文件与`_vars.scss`中的颜色定义紧密配合，确保所有UI元素在深色模式下保持视觉一致性。例如，输入框背景使用`--canvas-inset`，这在深色模式下对应`palette(darkgray, 5)`。

**Section sources**
- [bootstrap-dark.scss](file://ts/lib/sass/bootstrap-dark.scss#L0-L16)
- [_vars.scss](file://ts/lib/sass/_vars.scss#L0-L473)

## 主题管理JavaScript逻辑

主题管理的JavaScript逻辑主要在`theme.ts`中实现（通过`ts/lib/sveltelib/theme.ts`路径引用）。该系统利用Svelte的响应式特性管理主题状态。

核心功能包括：主题状态的存储与持久化、动态应用CSS类、响应系统主题变化。JavaScript代码通过读取用户偏好设置确定当前主题，并相应地修改文档的body类（如添加`nightMode`类）。

主题切换时，系统会触发样式更新，重新计算所有基于CSS变量的样式。这种设计实现了无需页面刷新的主题切换。同时，JavaScript逻辑与Python后端通过桥接机制同步状态，确保桌面应用各组件间的一致性。

**Section sources**
- [theme.py](file://qt/aqt/theme.py#L0-L433)

## 自定义主题指南

### 添加新主题
要添加新主题，需在`_vars.scss`的`$vars`映射中定义新的颜色方案。建议复制现有主题结构，修改颜色值。然后在`theme.py`的`Theme`枚举中添加新主题常量，并在`_determine_night_mode`方法中实现其逻辑。

### 修改现有颜色方案
修改颜色方案应直接编辑`_color-palette.scss`中的十六进制值，或调整`_vars.scss`中基于调色板的颜色映射。推荐使用`palette()`函数引用基础颜色，以保持一致性。

### 对比度可访问性最佳实践
1. 确保文本与背景的对比度至少达到4.5:1（AA级）
2. 使用`palette(darkgray, 9)`和`palette(lightgray, 0)`作为主要文字颜色
3. 避免在深色背景上使用纯白色文字，建议使用`palette(lightgray, 0)`或`palette(lightgray, 1)`
4. 验证状态色（如新卡片、学习中卡片）在两种模式下的可辨识性
5. 利用`color.scale()`函数微调颜色透明度和亮度，而非直接指定十六进制值

**Section sources**
- [_color-palette.scss](file://ts/lib/sass/_color-palette.scss#L0-L213)
- [_vars.scss](file://ts/lib/sass/_vars.scss#L0-L473)
- [theme.py](file://qt/aqt/theme.py#L0-L433)

## 结论
Anki的主题系统采用分层架构，将颜色定义、样式规则和状态管理分离。Sass预处理器提供了强大的颜色管理和样式生成能力，而Python后端确保了跨平台的一致性。通过CSS变量和类切换机制，实现了高效的主题切换。该系统设计灵活，易于扩展，同时注重可访问性，为用户提供舒适的视觉体验。