# 错误处理与异常传播

<cite>
**本文档中引用的文件**  
- [backend.proto](file://proto/anki/backend.proto)
- [_backend.py](file://pylib/anki/_backend.py)
- [errors.py](file://pylib/anki/errors.py)
- [lib.rs](file://pylib/rsbridge/lib.rs)
- [mod.rs](file://rslib/src/error/mod.rs)
- [network.rs](file://rslib/src/error/network.rs)
- [db.rs](file://rslib/src/error/db.rs)
- [backend/error.rs](file://rslib/src/backend/error.rs)
</cite>

## 目录
1. [简介](#简介)
2. [错误类型映射机制](#错误类型映射机制)
3. [核心错误分类](#核心错误分类)
4. [错误堆栈与上下文保留](#错误堆栈与上下文保留)
5. [Python层异常捕获](#python层异常捕获)
6. [自定义错误类型实现](#自定义错误类型实现)
7. [错误诊断指南](#错误诊断指南)
8. [性能影响与优化策略](#性能影响与优化策略)

## 简介
Anki采用Rust-Python混合架构，其错误处理机制通过PyO3桥接实现跨语言异常传播。Rust端的`Result<T, E>`类型通过Protobuf序列化转换为Python端的异常体系，确保类型安全的同时提供丰富的错误上下文信息。该机制支持错误分类、上下文追溯和国际化消息展示，为开发者提供了完整的错误诊断能力。

## 错误类型映射机制

```mermaid
flowchart TD
RustResult[Rust Result<T, E>] --> Serialize[Protobuf序列化]
Serialize --> PyO3[PyO3桥接层]
PyO3 --> Deserialize[反序列化为BackendError]
Deserialize --> Map[映射到Python异常]
Map --> PythonException[Python异常体系]
```

**图示来源**
- [backend.proto](file://proto/anki/backend.proto#L1-L62)
- [lib.rs](file://pylib/rsbridge/lib.rs#L46-L91)
- [_backend.py](file://pylib/anki/_backend.py#L168-L207)

**本节来源**
- [backend.proto](file://proto/anki/backend.proto#L1-L62)
- [lib.rs](file://pylib/rsbridge/lib.rs#L46-L91)

## 核心错误分类

```mermaid
classDiagram
class BackendError {
+message : str
+help_page : HelpPage
+context : str
+backtrace : str
}
class DBError {
+kind : DbErrorKind
+info : str
}
class NetworkError {
+kind : NetworkErrorKind
+info : str
}
class SyncError {
+kind : SyncErrorKind
+info : str
}
BackendError <|-- DBError
BackendError <|-- NetworkError
BackendError <|-- SyncError
BackendError <|-- Interrupted
BackendError <|-- InvalidInput
BackendError <|-- TemplateError
BackendError <|-- SearchError
BackendError <|-- FilteredDeckError
BackendError <|-- CustomStudyError
BackendError <|-- SchedulerUpgradeRequired
```

**图示来源**
- [errors.py](file://pylib/anki/errors.py#L27-L82)
- [mod.rs](file://rslib/src/error/mod.rs#L1-L324)
- [network.rs](file://rslib/src/error/network.rs#L1-L232)
- [db.rs](file://rslib/src/error/db.rs#L1-L107)

**本节来源**
- [errors.py](file://pylib/anki/errors.py#L27-L82)
- [mod.rs](file://rslib/src/error/mod.rs#L1-L324)

## 错误堆栈与上下文保留

```mermaid
sequenceDiagram
participant Rust as "Rust核心"
participant Bridge as "PyO3桥接"
participant Python as "Python层"
Rust->>Rust : 发生错误 AnkiError
Rust->>Rust : 转换为 BackendError Protobuf
Rust->>Bridge : 返回错误字节流
Bridge->>Python : 抛出 BackendError 异常
Python->>Python : backend_exception_to_pylib() 映射
Python->>Python : 创建具体异常类型
Python->>Python : 保留 message, context, backtrace
Note over Rust,Python : 错误上下文完整传递
```

**图示来源**
- [_backend.py](file://pylib/anki/_backend.py#L196-L262)
- [backend/error.rs](file://rslib/src/backend/error.rs#L1-L73)
- [mod.rs](file://rslib/src/error/mod.rs#L1-L324)

**本节来源**
- [_backend.py](file://pylib/anki/_backend.py#L196-L262)
- [backend/error.rs](file://rslib/src/backend/error.rs#L1-L73)

## Python层异常捕获

```mermaid
flowchart TD
Start([Python调用]) --> Try["try:"]
Try --> Call[Rust核心调用]
Call --> Success{成功?}
Success --> |是| Return[返回结果]
Success --> |否| Except["except Exception as e:"]
Except --> CheckType[检查异常类型]
CheckType --> HandleDB[DBError处理]
CheckType --> HandleNetwork[NetworkError处理]
CheckType --> HandleSync[SyncError处理]
CheckType --> HandleGeneric[通用BackendError处理]
HandleDB --> LogDB[记录数据库错误]
HandleNetwork --> Retry[网络重试逻辑]
HandleSync --> AuthCheck[认证检查]
HandleGeneric --> ShowUser[向用户展示]
LogDB --> End([结束])
Retry --> End
AuthCheck --> End
ShowUser --> End
```

**图示来源**
- [_backend.py](file://pylib/anki/_backend.py#L196-L262)
- [errors.py](file://pylib/anki/errors.py#L27-L82)

**本节来源**
- [_backend.py](file://pylib/anki/_backend.py#L196-L262)

## 自定义错误类型实现

```mermaid
classDiagram
class AnkiError {
+message(tr : I18n) String
+help_page() Option<HelpPage>
+context() String
+backtrace() String
}
class CardTypeError {
+notetype : String
+ordinal : usize
+source : CardTypeErrorDetails
}
class SearchErrorKind {
+ParseError
+InvalidRegex
+NoSuchField
}
class SyncErrorKind {
+Conflict
+ServerError
+AuthFailed
+ResyncRequired
+SanityCheckFailed
}
AnkiError <|-- CardTypeError
AnkiError <|-- SearchErrorKind
AnkiError <|-- SyncErrorKind
AnkiError <|-- NetworkError
AnkiError <|-- DbError
```

**图示来源**
- [mod.rs](file://rslib/src/error/mod.rs#L1-L324)
- [network.rs](file://rslib/src/error/network.rs#L1-L232)
- [db.rs](file://rslib/src/error/db.rs#L1-L107)

**本节来源**
- [mod.rs](file://rslib/src/error/mod.rs#L1-L324)

## 错误诊断指南

```mermaid
flowchart TD
Start([错误发生]) --> CheckLog[检查日志文件]
CheckLog --> HasBacktrace{有backtrace?}
HasBacktrace --> |是| AnalyzeStack[分析Rust堆栈]
HasBacktrace --> |否| CheckContext{有context?}
CheckContext --> |是| TraceContext[追溯上下文]
CheckContext --> |否| CheckType[检查错误类型]
CheckType --> DBError[DBError]
CheckType --> NetworkError[NetworkError]
CheckType --> SyncError[SyncError]
CheckType --> OtherError[其他错误]
DBError --> CheckKind[检查DbErrorKind]
DBError --> CheckInfo[检查info字段]
NetworkError --> CheckKind[检查NetworkErrorKind]
NetworkError --> CheckInfo[检查info字段]
SyncError --> CheckKind[检查SyncErrorKind]
SyncError --> CheckInfo[检查info字段]
CheckKind --> CommonIssues[常见问题排查]
CheckInfo --> CommonIssues
AnalyzeStack --> CommonIssues
TraceContext --> CommonIssues
CommonIssues --> Solution[解决方案]
Solution --> Prevent[预防措施]
Prevent --> End([完成])
```

**图示来源**
- [_backend.py](file://pylib/anki/_backend.py#L196-L262)
- [errors.py](file://pylib/anki/errors.py#L27-L82)
- [mod.rs](file://rslib/src/error/mod.rs#L1-L324)

**本节来源**
- [_backend.py](file://pylib/anki/_backend.py#L196-L262)
- [errors.py](file://pylib/anki/errors.py#L27-L82)

## 性能影响与优化策略

```mermaid
flowchart LR
subgraph 性能影响
A[Protobuf序列化开销]
B[跨语言调用延迟]
C[异常处理路径]
D[堆栈生成成本]
end
subgraph 优化策略
E[错误分类预处理]
F[关键路径异常最小化]
G[异步错误处理]
H[缓存常见错误消息]
end
A --> E
B --> F
C --> G
D --> H
style 性能影响 fill:#f9f,stroke:#333,stroke-width:2px
style 优化策略 fill:#bbf,stroke:#333,stroke-width:2px
```

**图示来源**
- [lib.rs](file://pylib/rsbridge/lib.rs#L46-L91)
- [_backend.py](file://pylib/anki/_backend.py#L168-L207)
- [backend/error.rs](file://rslib/src/backend/error.rs#L1-L73)

**本节来源**
- [lib.rs](file://pylib/rsbridge/lib.rs#L46-L91)
- [_backend.py](file://pylib/anki/_backend.py#L168-L207)