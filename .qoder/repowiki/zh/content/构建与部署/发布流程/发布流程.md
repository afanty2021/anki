# 发布流程

<cite>
**本文档中引用的文件**  
- [python/version.py](file://python/version.py)
- [rslib/src/version.rs](file://rslib/src/version.rs)
- [.version](file://.version)
- [Cargo.toml](file://Cargo.toml)
- [pyproject.toml](file://pyproject.toml)
- [qt/release/build.sh](file://qt/release/build.sh)
- [qt/launcher/mac/build.sh](file://qt/launcher/mac/build.sh)
- [qt/launcher/lin/build.sh](file://qt/launcher/lin/build.sh)
</cite>

## 目录
1. [版本管理策略](#版本管理策略)
2. [打包过程](#打包过程)
3. [分发机制](#分发机制)
4. [发布清单与质量保证](#发布清单与质量保证)
5. [自动化发布脚本示例](#自动化发布脚本示例)
6. [回滚策略指导](#回滚策略指导)

## 版本管理策略

Anki 采用语义化版本控制（Semantic Versioning）来管理其发布版本。版本号遵循 `主版本号.次版本号.修订号` 的格式，例如当前版本为 `25.09.2`。主版本号表示重大更新，可能包含不兼容的API变更；次版本号表示向后兼容的功能新增；修订号表示向后兼容的问题修复。

版本号存储在项目根目录下的 `.version` 文件中，该文件被多个组件读取以确保版本一致性。Rust 后端通过 `rslib/src/version.rs` 中的 `version()` 函数读取此文件内容，而 Python 前端则通过 `python/version.py` 模块中的 `__version__` 变量获取版本信息。此外，构建过程中还会注入 `BUILDHASH` 环境变量以标识具体的构建哈希值，用于调试和同步客户端版本识别。

**Section sources**
- [.version](file://.version)
- [rslib/src/version.rs](file://rslib/src/version.rs#L0-L37)
- [python/version.py](file://python/version.py#L0-L10)

## 打包过程

Anki 的打包过程涉及跨平台可执行文件生成、依赖捆绑和资源压缩。打包脚本分布在不同平台的构建目录中，如 macOS 和 Linux 的构建脚本分别位于 `qt/launcher/mac/build.sh` 和 `qt/launcher/lin/build.sh`。

对于 macOS 平台，`build.sh` 脚本首先为 `aarch64-apple-darwin` 和 `x86_64-apple-darwin` 两个架构分别编译二进制文件，然后使用 `lipo` 工具将它们合并成一个通用二进制文件。同时，`uv` 运行时环境也被复制到应用包中。最终生成的 `.app` 包含必要的资源文件（如图标、Info.plist 和 Python 版本配置），并通过 `codesign` 进行代码签名，并可选择性地进行公证（notarization）和 DMG 镜像制作。

对于 Linux 平台，`build.sh` 脚本同样支持多架构构建（`x86_64-unknown-linux-gnu` 和 `aarch64-unknown-linux-gnu`），生成带有架构后缀的二进制文件（如 `launcher.amd64` 和 `launcher.arm64`）。所有文件被打包成一个 `.tar.zst` 压缩包，使用 Zstandard 算法进行高压缩比压缩，确保分发效率。

**Section sources**
- [qt/launcher/mac/build.sh](file://qt/launcher/mac/build.sh#L0-L61)
- [qt/launcher/lin/build.sh](file://qt/launcher/lin/build.sh#L0-L88)

## 分发机制

Anki 的分发机制包括桌面应用安装包创建、插件分发和更新服务器配置。桌面应用的安装包通过平台特定的构建脚本生成：macOS 使用 DMG 镜像，Linux 使用压缩包，Windows 使用安装程序（未在当前结构中显示）。

插件分发通过 AnkiWeb 实现，用户可以从插件库下载和安装扩展功能。插件的元数据和配置文件存储在 `qt/launcher/addon/manifest.json` 中，定义了插件的名称、版本、作者和权限等信息。

更新服务器配置由 `qt/release/build.sh` 脚本管理，该脚本负责生成发布版本的 `pyproject.toml` 文件，锁定所有依赖项的精确版本。此文件用于构建发布轮子（wheel），确保所有用户安装的版本具有一致的依赖环境。更新检查通过内置的同步机制完成，客户端会定期向服务器查询最新版本信息。

**Section sources**
- [qt/release/build.sh](file://qt/release/build.sh#L0-L71)
- [qt/launcher/addon/manifest.json](file://qt/launcher/addon/manifest.json)

## 发布清单与质量保证

发布前必须完成以下质量保证检查点：

1. **版本号验证**：确认 `.version` 文件中的版本号符合语义化版本规范，并与上一版本有合理递进。
2. **构建测试**：在所有支持的平台上执行完整构建流程，确保无编译错误。
3. **依赖审计**：使用 `uv export` 命令导出所有依赖项列表，检查是否存在已知漏洞或不兼容版本。
4. **签名与公证**：macOS 应用必须经过有效的开发者证书签名，并提交至 Apple 进行公证。
5. **功能回归测试**：运行完整的测试套件，包括单元测试和集成测试，确保核心功能正常。
6. **性能基准测试**：对比前一版本的性能指标，确保无显著退化。
7. **文档更新**：同步更新用户手册、发行说明和 API 文档。

**Section sources**
- [qt/release/build.sh](file://qt/release/build.sh#L0-L71)
- [pyproject.toml](file://pyproject.toml#L0-L43)

## 自动化发布脚本示例

以下是一个简化的自动化发布脚本示例，整合了版本更新、依赖锁定和包构建流程：

```bash
#!/bin/bash
set -e

PROJ_ROOT="$(cd "$(dirname "$0")" && pwd)"
VERSION=$(cat "$PROJ_ROOT/.version")

echo "开始发布流程，版本: $VERSION"

# 更新版本文件
echo "更新版本信息..."
# （此处可添加版本递增逻辑）

# 构建 macOS 应用
echo "构建 macOS 应用..."
(cd "$PROJ_ROOT/qt/launcher/mac" && ./build.sh)

# 构建 Linux 应用
echo "构建 Linux 应用..."
(cd "$PROJ_ROOT/qt/launcher/lin" && ./build.sh)

# 生成发布依赖文件
echo "生成发布依赖..."
(cd "$PROJ_ROOT/qt/release" && ./build.sh)

# 打包并上传
echo "打包并上传至分发服务器..."
# （此处可添加上传命令）

echo "发布流程完成"
```

**Section sources**
- [qt/release/build.sh](file://qt/release/build.sh#L0-L71)
- [qt/launcher/mac/build.sh](file://qt/launcher/mac/build.sh#L0-L61)
- [qt/launcher/lin/build.sh](file://qt/launcher/lin/build.sh#L0-L88)

## 回滚策略指导

当发布版本出现严重问题时，应立即启动回滚流程：

1. **暂停分发**：从下载页面移除有问题的版本，阻止新用户下载。
2. **通知用户**：通过 AnkiWeb 和邮件列表发布紧急通知，指导用户回退到上一稳定版本。
3. **恢复构建环境**：检出上一版本的 Git 标签，确保构建环境与原发布一致。
4. **重新构建**：使用原始构建脚本重新生成安装包，避免引入新的变更。
5. **验证回滚版本**：在多种环境中测试回滚版本，确保问题已解决。
6. **重新分发**：将回滚版本重新上线，并提供明确的升级路径说明。
7. **问题分析**：收集错误报告，定位根本原因，并在修复后安排补丁发布。

回滚过程中应保持透明沟通，及时向社区通报进展，维护用户信任。

**Section sources**
- [qt/release/build.sh](file://qt/release/build.sh#L0-L71)
- [Cargo.toml](file://Cargo.toml#L0-L175)
- [pyproject.toml](file://pyproject.toml#L0-L43)