# 正常同步

<cite>
**本文档中引用的文件**  
- [normal.rs](file://rslib/src/sync/collection/normal.rs)
- [sync.py](file://qt/aqt/sync.py)
- [http_client.rs](file://rslib/src/sync/http_client/protocol.rs)
- [response.rs](file://rslib/src/sync/response.rs)
</cite>

## 目录
1. [简介](#简介)
2. [正常同步生命周期](#正常同步生命周期)
3. [状态机实现](#状态机实现)
4. [数据一致性保证](#数据一致性保证)
5. [与其他同步模式的对比](#与其他同步模式的对比)
6. [错误处理与恢复策略](#错误处理与恢复策略)
7. [常见问题与解决方案](#常见问题与解决方案)
8. [结论](#结论)

## 简介
正常同步是Anki同步系统中的核心双向同步模式，负责在客户端和服务器之间保持数据的最终一致性。该模式通过一系列协调的阶段来确保数据变更能够正确地在两端传播，同时处理各种边界情况和异常场景。

**Section sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L1-L20)

## 正常同步生命周期
正常同步会话包含五个主要阶段：握手、检查、上传、下载和完成。整个过程由`NormalSyncer`结构体协调管理。

```mermaid
flowchart TD
A[开始同步] --> B[握手与状态检查]
B --> C{是否有变更?}
C --> |否| D[同步完成]
C --> |是| E[处理本地删除]
E --> F[处理未分块变更]
F --> G[从服务器接收数据块]
G --> H[向服务器发送数据块]
H --> I[完整性检查]
I --> J[最终化同步]
J --> K[同步完成]
```

**Diagram sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L43-L66)
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L100-L130)

**Section sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L43-L178)

## 状态机实现
正常同步的状态机由`NormalSyncer`结构体实现，该结构体管理同步过程中的各个阶段和状态转换。

```mermaid
classDiagram
class NormalSyncer {
+col : Collection
+server : HttpSyncClient
+progress : ThrottlingProgressHandler
+new(col, server) NormalSyncer
+sync() Result~SyncOutput~
+normal_sync_inner(state) Result~SyncOutput~
}
class ClientSyncState {
+required : SyncActionRequired
+server_message : String
+host_number : u32
+new_endpoint : Option~String~
+local_is_newer : bool
+usn_at_last_sync : Usn
+server_usn : Usn
+pending_usn : Usn
+server_media_usn : Usn
}
class SyncOutput {
+required : SyncActionRequired
+server_message : String
+host_number : u32
+new_endpoint : Option~String~
+server_media_usn : Usn
}
NormalSyncer --> ClientSyncState : "使用"
NormalSyncer --> SyncOutput : "返回"
ClientSyncState --> SyncOutput : "转换"
```

**Diagram sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L10-L40)
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L43-L66)
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L133-L177)

**Section sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L10-L178)

## 数据一致性保证
正常同步通过多种机制确保客户端和服务器端数据的最终一致性。

### USN（更新序列号）机制
同步过程使用USN（Update Sequence Number）来跟踪变更，确保所有变更都能被正确处理。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Server as "服务器"
Client->>Server : 获取元数据 (sync_meta)
Server-->>Client : 返回服务器状态
Client->>Client : 比较本地和服务器USN
Client->>Server : 开始同步流程
Client->>Server : 处理删除操作
Client->>Server : 处理未分块变更
Client->>Server : 接收服务器数据块
Client->>Server : 发送本地数据块
Client->>Server : 完整性检查
Client->>Server : 最终化同步
Server-->>Client : 返回同步结果
```

**Diagram sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L43-L66)
- [http_client.rs](file://rslib/src/sync/http_client/protocol.rs#L81-L124)

**Section sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L43-L66)
- [http_client.rs](file://rslib/src/sync/http_client/protocol.rs#L81-L124)

## 与其他同步模式的对比
正常同步与其他同步模式（如快速同步）在适用场景和功能特性上有所不同。

```mermaid
graph TB
subgraph "同步模式"
A[正常同步]
B[快速同步]
C[完整同步]
end
A --> D["适用场景: 常规数据同步"]
A --> E["特点: 双向增量同步"]
A --> F["数据量: 中等"]
B --> G["适用场景: 快速状态检查"]
B --> H["特点: 轻量级检查"]
B --> I["数据量: 小"]
C --> J["适用场景: 数据恢复"]
C --> K["特点: 全量同步"]
C --> L["数据量: 大"]
```

**Diagram sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L1-L178)
- [response.rs](file://rslib/src/sync/response.rs#L38-L86)

**Section sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L1-L178)

## 错误处理与恢复策略
正常同步实现了完善的错误处理和恢复机制，确保在异常情况下能够正确恢复。

### 超时与资源管理
```mermaid
flowchart TD
A[开始同步] --> B[创建事务]
B --> C[执行同步操作]
C --> D{操作成功?}
D --> |是| E[提交事务]
D --> |否| F[回滚事务]
F --> G[中止服务器同步]
G --> H{完整性检查失败?}
H --> |是| I[标记模式修改]
H --> |否| J[返回错误]
E --> K[完成同步]
```

**Diagram sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L50-L100)
- [http_client.rs](file://rslib/src/sync/http_client/protocol.rs#L81-L124)

**Section sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L50-L100)

## 常见问题与解决方案
### 同步死锁
当多个同步操作同时尝试修改相同的数据时可能发生死锁。解决方案包括使用事务隔离和适当的锁管理。

### 状态不一致
由于网络中断或客户端崩溃可能导致状态不一致。系统通过完整性检查和事务回滚机制来解决此问题。

### 长时间运行同步的监控
```mermaid
graph LR
A[同步进度] --> B[阶段更新]
A --> C[本地更新计数]
A --> D[本地删除计数]
A --> E[远程更新计数]
A --> F[远程删除计数]
B --> G[UI更新]
C --> G
D --> G
E --> G
F --> G
```

**Diagram sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L15-L25)
- [sync.py](file://qt/aqt/sync.py#L78-L91)

**Section sources**
- [normal.rs](file://rslib/src/sync/collection/normal.rs#L15-L25)
- [sync.py](file://qt/aqt/sync.py#L78-L91)

## 结论
正常同步模式是Anki数据同步的核心机制，通过精心设计的状态机和协调逻辑，确保了客户端和服务器之间数据的最终一致性。该模式能够有效处理各种边界情况，包括空集合、大规模数据变更等，并提供了完善的错误恢复机制。